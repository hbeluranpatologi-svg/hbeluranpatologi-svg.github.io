
<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Directory Ujian Makmal</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#111;}
    body{margin:0; background:#f6f7fb;}
    header{padding:18px 20px; background:white; border-bottom:1px solid #e6e6ef;}
    .wrap{max-width:1100px; margin:0 auto;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .card{background:white; border:1px solid #e6e6ef; border-radius:14px; padding:14px;}
    input,select,button{padding:10px 12px; border-radius:10px; border:1px solid #d7d7e5; background:white;}
    button{cursor:pointer;}
    table{width:100%; border-collapse:collapse; font-size:14px;}
    th,td{padding:10px; border-bottom:1px solid #eee; vertical-align:top;}
    th{background:#fafafe; text-align:left; position:sticky; top:0;}
    .pill{display:inline-block; padding:3px 9px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#fff;}
    .muted{color:#666; font-size:12px;}
    .grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:12px; margin-top:12px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .detail h3{margin:0 0 10px;}
    .detail .kv{display:grid; grid-template-columns:160px 1fr; gap:8px 12px; font-size:14px;}
    .detail .kv div:nth-child(odd){color:#555;}
    .footer{padding:14px 0; text-align:center; color:#666; font-size:12px;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700; font-size:18px;">Directory Ujian Makmal</div>
        <div class="muted">Data dibaca dari catalog.xlsx (auto-update bila fail diganti)</div>
      </div>
      <div class="row">
        <button id="reload">Reload Data</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding:14px 20px 0;">
  <div class="card">
    <div class="row">
      <input id="q" placeholder="Cari: nama ujian / singkatan / spesimen / bahagian..." style="flex:1; min-width:260px;">
      <select id="dept" style="min-width:200px;"><option value="">Semua Bahagian</option></select>
      <select id="spec" style="min-width:200px;"><option value="">Semua Spesimen</option></select>
      <select id="tat" style="min-width:200px;"><option value="">Semua TAT</option></select>
      <button id="clear">Reset</button>
    </div>
    <div class="muted" id="meta" style="margin-top:8px;">Memuatkan data...</div>
  </div>

  <div class="grid">
    <div class="card" style="overflow:auto; max-height:70vh;">
      <table id="tbl">
        <thead>
          <tr>
            <th style="min-width:220px;">Ujian</th>
            <th style="min-width:140px;">Bahagian</th>
            <th style="min-width:140px;">Spesimen</th>
            <th style="min-width:120px;">TAT</th>
            <th style="min-width:120px;">Bekas/Tube</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card detail" id="detail">
      <div class="muted">Klik mana-mana row untuk lihat butiran.</div>
    </div>
  </div>

  <div class="footer">Tip: Untuk update, hanya upload semula <b>catalog.xlsx</b> dalam repo GitHub.</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  let rows = [];
  let filtered = [];
  let selectedIndex = -1;

  const el = (id)=>document.getElementById(id);
  const tbody = ()=>el('tbl').querySelector('tbody');

  function normalize(v){ return String(v ?? '').trim(); }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  function guessRow(raw){
    const get = (...keys)=>{ for (const k of keys){ if (raw[k] != null && String(raw[k]).trim() !== '') return raw[k]; } return ''; };
    return {
      TestName: normalize(get('TestName','Ujian','Nama Ujian','Test','TEST NAME','Nama_Ujian')),
      Abbreviation: normalize(get('Abbreviation','Singkatan','Code','Kod','Short','SHORT NAME')),
      Department: normalize(get('Department','Bahagian','Section','Disiplin','Unit')),
      Specimen: normalize(get('Specimen','Spesimen','Sample','Sampel')),
      Container: normalize(get('Container','Bekas','Tube','Tiub','Container/Tube')),
      Volume: normalize(get('Volume','Isipadu','Minimum Volume','Min Volume')),
      TAT: normalize(get('TAT','Turnaround Time','TAT (min)','TAT (hours)')),
      Method: normalize(get('Method','Kaedah','Instrument','Analyzer')),
      Storage: normalize(get('Storage','Simpanan','Stability','Storan')),
      RejectionCriteria: normalize(get('RejectionCriteria','Kriteria Penolakan','Rejection','Reject Criteria')),
      Remarks: normalize(get('Remarks','Catatan','Notes','Nota','Comment'))
    };
  }

  async function loadExcel(){
    try{
      const res = await fetch('catalog.xlsx?ts=' + Date.now());
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});
      rows = json.map(guessRow).filter(r => r.TestName || r.Abbreviation || r.Department || r.Specimen);
      buildFilters();
      applyFilters(true);
    }catch(e){
      el('meta').textContent = 'Gagal memuatkan catalog.xlsx. Pastikan fail telah di-upload di repo.';
      console.error(e);
    }
  }

  function buildFilters(){
    const uniq = (arr)=>[...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    const fill = (sel, items, label)=>{
      const s = el(sel);
      const cur = s.value;
      s.innerHTML = `<option value="">${label}</option>` + items.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      if (items.includes(cur)) s.value = cur;
    };
    fill('dept', uniq(rows.map(r=>r.Department)), 'Semua Bahagian');
    fill('spec', uniq(rows.map(r=>r.Specimen)), 'Semua Spesimen');
    fill('tat',  uniq(rows.map(r=>r.TAT)), 'Semua TAT');
  }

  function applyFilters(resetSelection=false){
    const q = el('q').value.toLowerCase().trim();
    const dept = el('dept').value;
    const spec = el('spec').value;
    const tat  = el('tat').value;

    filtered = rows.filter(r=>{
      if (dept && r.Department !== dept) return false;
      if (spec && r.Specimen !== spec) return false;
      if (tat  && r.TAT !== tat) return false;
      if (!q) return true;
      const hay = [r.TestName,r.Abbreviation,r.Department,r.Specimen,r.Container,r.TAT,r.Method,r.Storage,r.RejectionCriteria,r.Remarks].join(' ').toLowerCase();
      return hay.includes(q);
    });

    renderTable();
    el('meta').textContent = `Jumlah data: ${rows.length} | Dipaparkan: ${filtered.length}`;
    if (resetSelection){ selectedIndex=-1; renderDetail(null); }
  }

  function renderTable(){
    tbody().innerHTML = filtered.map((r, idx)=>`
      <tr data-idx="${idx}" style="cursor:pointer; ${idx===selectedIndex?'background:#f1f5ff':''}">
        <td><div style="font-weight:600;">${escapeHtml(r.TestName||'(Tiada Nama)')}</div>${r.Abbreviation?`<div class="muted">(${escapeHtml(r.Abbreviation)})</div>`:''}</td>
        <td>${r.Department?`<span class="pill">${escapeHtml(r.Department)}</span>`:''}</td>
        <td>${r.Specimen?`<span class="pill">${escapeHtml(r.Specimen)}</span>`:''}</td>
        <td>${escapeHtml(r.TAT)}</td>
        <td>${escapeHtml(r.Container)}</td>
      </tr>`).join('');

    [...tbody().querySelectorAll('tr')].forEach(tr=>{
      tr.addEventListener('click', ()=>{ selectedIndex=Number(tr.dataset.idx); renderTable(); renderDetail(filtered[selectedIndex]||null); });
    });
  }

  function renderDetail(r){
    const box = el('detail');
    if(!r){ box.innerHTML='<div class="muted">Klik mana-mana row untuk lihat butiran.</div>'; return; }
    const kv=(k,v)=> v?`<div>${escapeHtml(k)}</div><div>${escapeHtml(v)}</div>`:'';
    box.innerHTML=`<h3>${escapeHtml(r.TestName||'')} ${r.Abbreviation?`<span class="pill">${escapeHtml(r.Abbreviation)}</span>`:''}</h3>
      <div class="kv">
        ${kv('Bahagian', r.Department)}
        ${kv('Spesimen', r.Specimen)}
        ${kv('Bekas/Tube', r.Container)}
        ${kv('Isipadu', r.Volume)}
        ${kv('TAT', r.TAT)}
        ${kv('Kaedah/Analyzer', r.Method)}
        ${kv('Simpanan/Stability', r.Storage)}
        ${kv('Kriteria Penolakan', r.RejectionCriteria)}
        ${kv('Catatan', r.Remarks)}
      </div>`;
  }

  el('q').addEventListener('input', ()=>applyFilters());
  el('dept').addEventListener('change', ()=>applyFilters(true));
  el('spec').addEventListener('change', ()=>applyFilters(true));
  el('tat').addEventListener('change', ()=>applyFilters(true));
  el('clear').addEventListener('click', ()=>{ el('q').value=''; el('dept').value=''; el('spec').value=''; el('tat').value=''; applyFilters(true); });
  el('reload').addEventListener('click', loadExcel);

  loadExcel();
</script>
</body>
</html>
